{{template "header" .}}
{{with .Data}}
{{block "survey" .}}
<script>
    htmx.onLoad((el) => {
        for (let editor of el.getElementsByClassName('editor')) {
            new Quill(editor, {
                theme: 'snow',
            })
        }
        for (let options of el.getElementsByClassName('options')) {
            Sortable.create(options, {
                handle: '.drag-handle'
            })
        }
        for (let questions of htmx.findAll(el, '.questions')) {
            console.log(questions)
            Sortable.create(questions, {
                group: 'questions',
                handle: '.drag-handle',
                onEnd: (e) => {
                    console.log(e);
                    if (e.newIndex === e.oldIndex && e.to.dataset.blockid === e.from.dataset.blockId) {
                        return
                    }
                    htmx.find(e.item, 'input[name=index]').value = e.newIndex
                    htmx.find(e.item, 'input[name=blockId]').value = e.to.dataset.blockid
                    htmx.trigger(htmx.find(e.item, 'form'), "reorder")
                }
            })
        }
    })
</script>
<div class="section container">
    {{block "navigation" .}}
    <div class="block navigation">
        <nav class="breadcrumb" aria-label="breadcrumbs">
            <ul>
                <li><a href="/manage/dashboard">Surveys</a></li>
                <li class="is-active"><a href="/manage/survey/{{.Id}}" aria-current="page">{{.Title}}</a></li>
            </ul>
        </nav>
        <div class="level">
            {{block "survey-title" .}}
            <div class="level-item level-left">
                <h1 class="title">
                    <span>Survey {{.Title}}</span>
                    <span hx-get="/manage/survey/{{.Id}}/title/edit" hx-target="closest div" hx-swap="outerHTML" class="icon is-small is-clickable">
                        <span class="mdi mdi-pencil is-size-4"></span>
                    </span>
                </h1>
            </div>
            {{end}}
            <div class="level-item level-right">
                <button class="button is-primary level-item level-right" hx-post="/manage/survey/{{.Id}}/block" hx-target="#blocks" hx-swap="beforeend">
                    <span class="icon">
                        <span class="mdi mdi-plus"></span>
                    </span>
                    <span>Add new block</span>
                </button>
            </div>
        </div>
    </div>
    {{end}}
    <div id="blocks">
        {{range $i, $block := .Blocks}}
        {{block "block" .}}
        {{template "block.html" .}}
        {{end}}
        {{end}}
    </div>
</div>
{{end}}
{{end}}
{{template "footer" .}}